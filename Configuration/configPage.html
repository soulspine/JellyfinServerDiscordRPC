<!DOCTYPE html>
<html>

<head>
    <title>Discord RPC Configuration</title>
</head>

<body style="background: black;">
    <div data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-checkbox"
        id="DiscordRpcPage" style="color: #eee;">
        <div data-role="content">
            <div class="content-primary">
                <h1>Discord RPC Configuration</h1>

                <form id="discordRpcConfigForm">
                    <div class="inputContainer" style="margin-bottom: 2em;">
                        <label for="discordBotToken">Discord Bot Token</label>
                        <div style="display: flex; align-items: center;">
                            <input id="discordBotToken" is="emby-input" name="discordBotToken" type="password"
                                style="flex: 1;" />
                            <button id="btnShowBotToken" is="emby-button" type="button" class="raised"
                                style="margin-left: 8px;">Show</button>
                        </div>
                        <div class="fieldDescription">Token for your discord bot</div>
                    </div>

                    <div class="inputContainer" style="margin-bottom: 2em;">
                        <label for="discordImagesChannelId">Discord Image Conversion Channel Id</label>
                        <div style="display: flex; align-items: center;">
                            <input id="discordImagesChannelId" is="emby-input" name="discordImagesChannelId"
                                type="password" style="flex: 1;" />
                            <button id="btnShowChannelId" is="emby-button" type="button" class="raised"
                                style="margin-left: 8px;">Show</button>
                        </div>
                        <div class="fieldDescription">Discord channel ID that will be used to convert publicly available
                            images to Discord's media proxy standard.</div>
                    </div>

                    <label class="checkboxContainer emby-checkbox-label">
                        <input is="emby-checkbox" type="checkbox" id="localizedNames" data-embycheckbox="true"
                            class="emby-checkbox">
                        <span class="checkboxLabel">Use Localized Names</span>
                        <span class="checkboxOutline">
                            <span class="material-icons checkboxIcon checkboxIcon-checked check"
                                aria-hidden="true"></span>
                            <span class="material-icons checkboxIcon checkboxIcon-unchecked" aria-hidden="true"></span>
                        </span>
                    </label>
                    <div class="fieldDescription">Use localized titles for media instead of original names.</div>

                    <h1>Users</h1>
                    <p>Below are the registered Jellyfin users on this server. Paste each user's Discord client token in
                        the field next to their name to enable the Discord RPC.</p>

                    <div id="userList"></div>

                    <div style="margin-top: 2em;">
                        <button is="emby-button" type="submit" class="raised button-submit emby-button">Save
                            Settings</button>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            (() => {
                const pluginId = "ab0a8ab3-ceb0-49b0-980c-087d2a9c320b";
                const page = document.querySelector('#DiscordRpcPage');
                const form = document.querySelector('#discordRpcConfigForm');

                function setupToggle(buttonId, inputId) {
                    const btn = document.getElementById(buttonId);
                    const input = document.getElementById(inputId);
                    btn.addEventListener('click', () => {
                        input.type = input.type === 'password' ? 'text' : 'password';
                        btn.textContent = input.type === 'password' ? 'Show' : 'Hide';
                    });
                }

                function normalizeUsers(users) {
                    if (Array.isArray(users)) return users;
                    return users.Items || users.Users || [];
                }

                function render(users, config) {
                    const container = document.querySelector('#userList');
                    container.innerHTML = '';
                    document.querySelector('#localizedNames').checked = config.LocalizedNames || false;

                    users.forEach(u => {
                        const name = u.Name;
                        const row = document.createElement('div'); row.className = 'inputContainer';
                        row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.marginBottom = '1em';

                        const left = document.createElement('div'); left.style.flex = '1';
                        const title = document.createElement('h3'); title.textContent = name; title.style.margin = '0';
                        left.appendChild(title);

                        const right = document.createElement('div'); right.style.flex = '1'; right.style.display = 'flex'; right.style.alignItems = 'center';
                        const input = document.createElement('input');
                        input.setAttribute('is', 'emby-input');
                        input.type = 'password';
                        input.setAttribute('data-username', name);
                        input.value = (Array.isArray(config.UserTokens) ? (config.UserTokens.find(t => t.Username === name) || {}).DiscordToken : '') || '';
                        input.style.flex = '1';

                        const btn = document.createElement('button'); btn.setAttribute('is', 'emby-button'); btn.className = 'raised'; btn.type = 'button'; btn.textContent = 'Show'; btn.style.marginLeft = '8px';
                        btn.addEventListener('click', () => {
                            input.type = input.type === 'password' ? 'text' : 'password';
                            btn.textContent = input.type === 'password' ? 'Show' : 'Hide';
                        });

                        right.appendChild(input); right.appendChild(btn);
                        row.appendChild(left); row.appendChild(right); container.appendChild(row);
                    });
                }

                async function loadConfig() {
                    Dashboard.showLoadingMsg();
                    try {
                        const [usersResp, config] = await Promise.all([ApiClient.getUsers(), ApiClient.getPluginConfiguration(pluginId)]);
                        const users = normalizeUsers(usersResp || []);
                        document.querySelector('#discordBotToken').value = config.DiscordBotToken || '';
                        document.querySelector('#discordImagesChannelId').value = config.DiscordImagesChannelId || '';
                        render(users, config || {});
                    } catch (e) {
                        console.error('loadConfig error', e);
                    } finally {
                        Dashboard.hideLoadingMsg();
                    }
                }

                async function saveConfig(e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();
                    try {
                        const config = await ApiClient.getPluginConfiguration(pluginId);
                        config.DiscordBotToken = document.querySelector('#discordBotToken').value;
                        config.DiscordImagesChannelId = document.querySelector('#discordImagesChannelId').value;
                        config.LocalizedNames = document.querySelector('#localizedNames').checked;
                        const tokenInputs = document.querySelectorAll('#userList input[data-username]');
                        config.UserTokens = Array.from(tokenInputs).map(i => ({
                            Username: i.dataset.username,
                            DiscordToken: i.value
                        }));
                        const result = await ApiClient.updatePluginConfiguration(pluginId, config);
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    } catch (e) {
                        console.error('saveConfig error', e);
                    } finally {
                        Dashboard.hideLoadingMsg();
                    }
                    return false;
                }

                setupToggle('btnShowBotToken', 'discordBotToken');
                setupToggle('btnShowChannelId', 'discordImagesChannelId');
                page.addEventListener('pageshow', loadConfig);
                form.addEventListener('submit', saveConfig);
            })();
        </script>